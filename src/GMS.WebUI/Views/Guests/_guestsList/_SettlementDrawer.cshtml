@* Settlement Content - Displayed inside Billing Modal *@
@model GMS.Infrastructure.ViewModels.Guests.GuestsListViewModel
<style>
    /* Settlement Content Styling */
    #settlementModalContent {
        padding: 0 20px 20px 20px;
    }

    /* Base Table Styling - Match GMS theme */
    .table.settlement,
    #tblSettlementAttributes {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border: #dedede solid 1px;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.05);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin-bottom: 16px;
    }

    /* Header cells */
    .table.settlement th {
        background-color: #f5f7fa;
        color: #333;
        text-align: left;
        padding: 12px 16px;
        font-weight: 600;
        border-bottom: 1px solid #e0e6ed;
    }

    /* Data cells */
    .table.settlement td {
        padding: 12px 16px;
        color: #444;
        border-bottom: 1px solid #f0f2f5;
        vertical-align: middle;
    }

    /* Form input inside cells */
    .table.settlement .form-control-c {
        padding: 6px 10px;
        font-size: 14px;
        border: 1px solid #d1d9e6;
        border-radius: 6px;
        outline: none;
        transition: border-color 0.3s ease;
        width: 150px;
        min-width: 150px;
        text-align: right;
        background-color: #fff;
        color: #333;
    }

    .table.settlement .form-control-c:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.15);
    }

    .fc-parent {
        padding: 0 !important;
    }

    /* Settlement Form Fields */
    .settlement-form-section {
        background-color: #fff;
        border: 1px solid #dedede;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }

    .settlement-form-section .form-group {
        margin-bottom: 16px;
    }

    .settlement-form-section .form-group:last-child {
        margin-bottom: 0;
    }

    .settlement-form-section label,
    .settlement-form-section .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
        font-size: 13px;
    }

    .settlement-form-section .form-control {
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        background-color: #fff;
        color: #333;
    }

    .settlement-form-section .form-control:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.15);
    }

    .settlement-form-section textarea.form-control {
        min-height: 80px;
        resize: vertical;
    }

    /* Settlement Buttons */
    .settlement-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 16px 20px;
        border-top: 1px solid #e0e6ed;
        margin-top: 16px;
    }

    /* Guest Info Card - Match GMS theme */
    .settlement-guest-info {
        background-color: #98c1d9;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }

    .settlement-guest-info .form-label {
        font-size: 11px;
        font-weight: 600;
        color: #333;
        margin-bottom: 3px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .settlement-guest-info .headingInfo {
        font-size: 14px;
        font-weight: 600;
        color: #000;
    }

    /* Amount Display */
    .table.settlement .invoicedamount,
    .table.settlement .paymentcollected,
    .table.settlement .balance {
        font-weight: 600;
        font-size: 14px;
        text-align: right;
        color: #333;
    }

    /* Balance Highlight */
    .table.settlement tr:has(.balance),
    #tblSettlementAttributes tr:has(.balance) {
        background-color: #fff3cd;
    }
    
    .table.settlement tr:has(.balance) th,
    .table.settlement tr:has(.balance) td,
    #tblSettlementAttributes tr:has(.balance) th,
    #tblSettlementAttributes tr:has(.balance) td {
        font-weight: 600;
        color: #333;
    }
    
    .table.settlement tr:has(.balance) .balance,
    #tblSettlementAttributes tr:has(.balance) .balance {
        color: #856404;
        font-weight: 700;
    }

    /* Alert Styling */
    .settlement-alert {
        border-radius: 6px;
        border-left: 4px solid #ffc107;
        background-color: #fff3cd;
        color: #856404;
    }

    /* Ensure all inputs use standard styling */
    #settlementModalContent input[type="text"],
    #settlementModalContent input[type="number"],
    #settlementModalContent input[type="email"],
    #settlementModalContent textarea,
    #settlementModalContent select {
        background-color: #fff;
        border: 1px solid #ced4da;
        color: #333;
    }
    
    #settlementModalContent {
        color: #333;
    }
    
    #settlementModalContent label,
    #settlementModalContent .form-label {
        color: #333;
    }

    #settlementModalContent h6 {
        color: #333;
        font-weight: 600;
    }
    
    /* Modal body background - keep default */
    #BillingModal .modal-body {
        background-color: inherit;
    }
</style>

<div id="settlementModalContent">
    @* Guest Information Section - Match GMS billing style *@
    <div class="resposive_table review_table" style="background:#98c1d9; margin-bottom: 16px;">
        <table class="table table-striped" style="margin-bottom:0px !important">
            <tbody style="color:#000">
                <tr>
                    <td>UHID <br /> <span class="headingInfo">#@Model?.MembersWithAttributes?.UHID </span> </td>
                    <td>Guest Name <br /><span class="headingInfo">@Model?.MembersWithAttributes?.CustomerName</span></td>
                    <td>Mobile No <br /> <span class="headingInfo">@Model?.MembersWithAttributes?.MobileNo</span></td>
                </tr>
                <tr>
                    <td class="no-border">Stay Dates <br /><span class="headingInfo">@Model?.MembersWithAttributes?.DateOfArrival?.ToString("dd MMM yyyy") - @Model?.MembersWithAttributes?.DateOfDepartment?.ToString("dd MMM yyyy")</span></td>
                    <td class="no-border">Room Type <br /><span class="headingInfo">@Model?.MembersWithAttributes?.RoomTypeName</span></td>
                    <td class="no-border"></td>
                </tr>
            </tbody>
        </table>
    </div>

    @* Settlement Amounts Section *@
    <div class="row">
        @{
            double invoicedAmount = Model?.BillingDataList?.Where(x => x.ServiceType == "GrossAmount").FirstOrDefault()?.TotalAmount ?? 0;
            double paymentCollected = Model?.PaymentsWithAttr?.Sum(x => x.Amount) ?? 0;
        }
        <div class="col-md-6 m-auto">
            <table class="table settlement" id="tblSettlementAttributes">
                <tbody>
                    <tr>
                        <th>Invoiced Amount</th>
                        <td colspan="2" class="invoicedamount">@invoicedAmount.ToString("N2")</td>
                    </tr>
                    <tr>
                        <th>Payment Collected</th>
                        <td colspan="2" class="paymentcollected">@paymentCollected.ToString("N2")</td>
                    </tr>
                    <tr>
                        <th>Balance</th>
                        <td colspan="2" class="balance">@((invoicedAmount - paymentCollected).ToString("N2"))</td>
                    </tr>
                    <tr class="@((paymentCollected>invoicedAmount)?"":"d-none") refund-row">
                        <th>Refund</th>
                        <td colspan="2" class="refund text-right fc-parent">
                            <input type="number" step="0.01" class="form-control-c text-right" value="0" placeholder="0.00" />
                        </td>
                    </tr>
                    <tr class="@((paymentCollected>invoicedAmount)?"":"d-none")">
                        <th>Credit Amount</th>
                        <td colspan="2" class="creditamount text-right fc-parent">
                            <input type="number" step="0.01" class="form-control-c text-right" value="0" placeholder="0.00" />
                        </td>
                    </tr>
                    <tr class="@((paymentCollected<invoicedAmount)?"":"d-none")">
                        <th>Debit Note Amount</th>
                        <td colspan="2" class="debitamount text-right fc-parent">
                            <input type="number" step="0.01" class="form-control-c text-right" value="0" placeholder="0.00" />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    @* Settlement Details Form Section *@
    <div class="settlement-form-section">
        <h6 class="mb-3" style="font-weight: 600;">Settlement Details</h6>
        <div class="row">
            <div class="col-md-6 form-group inputcreditamount">
                <label class="form-label">Credit Note No.</label>
                <input type="text" name="NoteNumber" class="form-control" value="@Model?.SettlementDTO?.NoteNumber" readonly />
            </div>
            <div class="col-md-6 form-group inputcreditamount">
                <label class="form-label">Valid Till</label>
                <input type="text" name="ValidTill" class="form-control" placeholder="Select date" />
            </div>
            <div class="col-md-6 form-group inputdebitamount">
                <label class="form-label">Debit Note No.</label>
                <input type="text" name="DebitNoteNumber" class="form-control" value="@Model?.SettlementDTO?.DebitNoteNumber" readonly />
            </div>
            <div class="col-md-6 form-group inputdebitamount">
                <label class="form-label">Estimated Recovery Date</label>
                <input type="text" name="DebitNoteValidTill" class="form-control dateonly" dateformat="YYYY-MM-DD" autocomplete="off" placeholder="Select date" />
            </div>
            <div class="col-md-12 form-group inputrefund @((paymentCollected>invoicedAmount)?"":"d-none")">
                <label class="form-label">Refund Remarks</label>
                <textarea name="RefundRemarks" class="form-control" rows="3" placeholder="Enter refund remarks (optional)"></textarea>
            </div>
        </div>
    </div>
    
    @* Settlement Status Display *@
    @if (Model?.SettlementDTO != null && Model.SettlementDTO.DebitAmount > 0)
    {
        <div class="alert alert-warning settlement-alert">
            <strong><i class="bi bi-exclamation-triangle"></i> Debit Note Pending for Approval</strong><br />
            <small>Settlement is partially complete. Waiting for accounts approval of the debit note.</small>
        </div>
    }

    @* Hidden Fields *@
    <input type="hidden" name="GuestId" value="@Model?.MembersWithAttributes?.Id" />
    <input type="hidden" name="GuestIdPaxSN1" value="@(Model?.MembersWithAttributes?.GuestIdPaxSN1)" />

    @* Settlement Action Buttons *@
    <div class="settlement-actions">
        <button type="button" class="btn btn-secondary" onclick="InitiateSettlementAndSave()">
            <i class="bi bi-check-circle"></i> Settle
        </button>
        <button type="button" class="btn btn-primary" onclick="window.open('/Guests/PrintInvoice/@Model?.MembersWithAttributes?.Id','_blank')">
            <i class="bi bi-printer"></i> Print Invoice
        </button>
        @if (Model?.SettlementDTO?.CreditAmount > 0)
        {
            <button type="button" class="btn btn-success" onclick="window.open('/Guests/PrintCreditNote/@Model?.MembersWithAttributes?.Id','_blank')">
                <i class="bi bi-receipt"></i> Print Credit Note
            </button>
        }
    </div>
</div>
